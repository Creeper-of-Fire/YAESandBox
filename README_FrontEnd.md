**YAESandBox 前端设计总结**

**1. 应用形态:**

*   一个**单页面 Web 应用程序 (Single-Page Application, SPA)**，在浏览器单个标签页内运行。

**2. 核心视图与布局:**

*   **中央主区域:** 固定区域，用于展示核心的**垂直无限滚动 Block 流**。每个元素是一个 `BlockBubble`，类似聊天记录或论坛楼层。
*   **灵活面板系统:** 应用界面提供多个可用的“面板插槽”（如左侧、右侧、顶部工具栏下方区域）。这些插槽用于动态加载和显示各种功能面板。布局并非固定三栏，而是由用户按需配置。
*   **模块化组件:** 各种功能（如 Block 详情查看器、实体列表、GameState 编辑器、元数据编辑器、冲突解决器、生成设置面板等）被封装为独立的 UI 组件。用户可以通过顶部工具栏、Block 上的快捷操作或其他交互方式，将这些组件加载到不同的面板插槽中，或将其隐藏/关闭。

**3. 核心组件 (`BlockBubble` & `SiblingPager`):**

*   **`BlockBubble`:**
    *   中栏 Block 流的基本单元。
    *   显示对应 Block 的**完整 `blockContent`**。内容可能很长，组件内部需处理滚动或提供折叠/展开机制。
    *   包含用于**触发生成下一个 Block** 的交互控件（例如按钮、输入区域等），该控件与当前 `BlockBubble` 关联。
    *   内嵌**极简化的 `SiblingPager` 控件**。
*   **`SiblingPager`:**
    *   外观极简，仅显示**页码信息**（如“分支 2/5”）和**左右翻页按钮 (`<`, `>`)**。
    *   **翻页即时切换主路径分支:** 点击翻页按钮会**立即**更新当前 `BlockBubble` 显示的内容为翻到的那个兄弟节点，并动态调整该气泡下方的后续 Block 视图。**切换并非废弃旧路径**，只是改变当前视图的焦点和路径选择状态。

**4. 主要交互流程:**

*   **浏览与探索:** 用户通过中栏上下滚动浏览主路径。通过 `SiblingPager` 的翻页按钮无缝、即时地切换到不同的分支进行探索。
*   **生成新节点:** 在某个 `BlockBubble` 内部的特定控件触发 `TriggerMainWorkflow`，在其下方生成一个新的 `BlockBubble` 作为当前路径的延伸。
*   **编辑流程:**
    *   通过某种方式（例如 `BlockBubble` 上的快捷按钮或右键菜单）触发，将“实体编辑器”组件加载到某个面板插槽。
    *   在编辑器中选择实体，修改属性。
    *   完成后点击“保存更改”，调用 `POST /api/atomic/{blockId}` 将原子操作提交给**对应的 Block**。
*   **AI 辅助编辑 ("润色"):** 在实体编辑器的字符串属性旁提供 ✨ 按钮，点击调用 `TriggerMicroWorkflow`（后端负责上下文），结果通过 `ReceiveDisplayUpdate`（带 `targetElementId`）直接更新对应输入框。
*   **重新生成:** 触发对一个**已存在** Block 的内容和状态进行重新生成，但**保持其子节点结构不变**（逻辑一致性由用户或工作流承担）。

**5. 状态管理与数据处理:**

*   **前端维护路径选择:** 前端使用类似 `Map<parentId, selectedChildId>` 的机制，记录在每个父节点下，当前主路径选择了哪个子节点。这是决定中栏视图的关键状态。
*   **盲存用于路径恢复:** 保存会话时，前端将**每个路径的最底层叶节点 ID **以及**当前路径的最底层叶节点 ID ** 存入盲存数据。加载会话时，前端利用此 ID 和后端恢复的 Block 数据，通过回溯父节点引用来重建用户上次查看的完整主路径。
*   **客户端图结构:** 前端在加载或数据更新后，解析后端提供的 `topology` 和 `blocks` 数据，构建便于快速查找父、子、兄弟关系的内存数据结构（例如 `Map<string, ProcessedBlockInfo>`）。

**6. 内容渲染 (`blockContent`):**

*   **统一访问:** 实现 `getContentToRender()` 函数，优先返回脚本处理后的 `processedContent`，若无则返回 `originalContent`（均为只读访问）。
*   **解析与渲染:** 对 `getContentToRender()` 返回的内容进行处理：
    *   **分块:** 按预定规则（如双换行符）分割内容。
    *   **格式识别:** 识别并提取 ` ```<format>...</format>``` ` 格式块。
    *   **渲染:** 根据 `<format>` 调用相应的渲染库（Markdown、代码高亮等）。普通文本直接显示。
*   **脚本执行 (可选):** 如果 `DisplayUpdateDto` 包含 `script` 字符串，前端直接执行该脚本（**用户自行承担安全风险**），其输出作为 `processedContent`。


**7. 核心原则与风格:**

*   **直接性与效率:** 避免不必要的 UI 动画，追求即时反馈和操作效率。
*   **探索性:** 鼓励用户通过简化的 Pager 轻松探索所有叙事可能性。
*   **持久性:** Block 世界图是持久的，用户交互只是改变当前的“视点”或对其进行修改/扩展。
*   **灵活性与可配置性:** 通过灵活的面板系统提供用户自定义界面的能力。
*   **用户责任:** 用户负责本地部署的脚本执行安全，以及重新生成操作可能带来的逻辑一致性问题。
*   **前后端责任分离:** 后端提供数据、结构、操作和核心逻辑；前端负责视图渲染、交互逻辑、当前路径选择状态和与后端通信。