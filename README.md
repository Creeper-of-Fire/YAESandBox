# YAESandBox - AI 原生可扩展工作流引擎

YAESandBox 是一个全栈、插件化的平台，用于构建和运行由 AI 驱动的复杂交互式应用。它包含一个后端工作流引擎、一个基于 Tauri 的跨平台启动器（目前只编译了Windows版），以及一套用于开发和管理工作流的可视化前端工具。

项目的核心是**YAESandBox 引擎**，但其最终目的是为了驱动像 **`era-lite` (对话式应用框架)** 和 **`era-map` (地图式沙盒模拟框架)** 这样的上层应用。

## 核心概念

系统架构围绕三个核心概念构建，形成了 `工作流 (Workflow) -> 枢机 (Tuum) -> 符文 (Rune)` 的层级关系。

*   **符文 (Rune):** 最小的、不可再分的执行单元。它代表一个具体的操作，例如：调用一次 AI 模型、执行一段 Lua 脚本或解析一段文本。
*   **枢机 (Tuum):** 一个由多个符文构成的、可复用的逻辑集合，功能上等同一个“函数”或“子程序”。枢机拥有独立的内部变量作用域，并通过输入/输出映射与外部进行数据交换。
*   **工作流 (Workflow):** 由多个枢机连接而成的最高层级执行图（DAG），定义了应用的宏观业务流程。
*   **枢机符文 (TuumRune):** 这是一个特殊的符文，其内部封装了另一个完整的枢机。这使得复杂的逻辑可以被层层嵌套和抽象，实现了架构上的**分形设计**，极大提升了工作流的组织能力和复用性。

### 双层数据流模型

为了兼顾不同层级逻辑的编排需求，系统采用了两种数据流模型：

1.  **宏观 (工作流 ↔ 枢机): 图形化连接**
    在高层级，使用显式节点连接来定义枢机之间的执行顺序和数据依赖。如果未进行连接，引擎能够基于依赖关系自动进行拓扑排序和并行调度。
2.  **微观 (枢机内部): 变量总线**
    在枢机内部，符文之间通过“生产-消费”模式与内部变量总线交互。这种设计降低了符文间的耦合，简化了枢机内部的逻辑配置。

## 关键特性

*   **🔌 全栈插件化架构:**
    *   后端通过依赖注入自动发现并加载插件提供的符文。
    *   前端 `shell` 应用动态加载插件提供的 Vue 组件、路由和静态资源。

*   **🚀 并行工作流引擎:**
    *   自动分析数据依赖关系，构建有向无环图 (DAG)。
    *   **并行执行**无依赖关系的枢机，显著提升 I/O 密集型任务（如多次 AI 调用）的效率。
    *   内置工作流持久化系统，支持幂等执行与状态恢复。

*   **🔬 实时静态分析:**
    *   在保存和执行前，对数据流、变量类型兼容性和符文配置规则进行全面校验，提供“编译时”级别的安全性。

*   **🤖 可插拔 AI 服务:**
    *   独立的 `AIService` 模块，支持通过配置文件接入不同的 AI 模型（已内置火山豆包、DeepSeek、Gemini、自定义模型 等）。
    *   可根据后端 C# 类的 Attribute **自动为任何 AI 模型生成前端配置表单**。

*   **🛠️ 功能丰富的可视化工作台 (`workbench`):**
    *   提供对工作流、枢机、符文的完整 CRUD 管理。
    *   **动态 Schema 驱动 UI:** 可根据后端 C# 模型定义自动渲染配置表单，原生支持 Monaco Editor 和自定义 Vue 组件。
    *   **上下文感知编辑:** 在配置时提供变量的自动完成和实时错误提示。
    *   **内置测试工具:** 支持在编辑器内对单个符文进行在线模拟运行，快速验证逻辑。（部分符文不支持测试，强行运行会出错）

*   **📜 强大的脚本符文:**
    *   **Lua 脚本插件:** 内置 Lua 脚本符文，通过 Bridge 与 .NET 环境交互，并为 Monaco Editor 提供了完整的智能提示和内置库支持。

## 项目结构

本项目为 Monorepo 结构，各模块职责清晰：

-   `backend/`: .NET 后端项目。
    -   `YAESandBox.AppWeb/`: 主机应用，负责启动服务、加载所有模块和插件。
    -   `YAESandBox.Workflow/`: **核心工作流引擎**，包含引擎、API、分析服务和内置符文。
    -   `YAESandBox.Workflow.AIService/`: AI 服务管理模块。
    -   `YAESandBox.PlayerServices.Save/`: 游戏存档服务模块。
    -   `YAESandBox.Depend.*/`: 底层共享库。
-   `frontend/`: 前端项目。
    -   `apps/`: 独立的前端应用程序。
        -   `launcher/`: **基于 Tauri 的跨平台桌面启动器**，是用户的**主要入口**。
        -   `shell/`: 主应用外壳，负责加载所有前端插件。
    -   `plugins/`: 可被 `shell` 加载的前端功能插件。
        -   `workbench/`: **核心的可视化编辑器**，用于开发和调试工作流。
        -   `era-lite/`: 一个基于本引擎构建的**对话式应用框架**，包含完整的存档、角色、物品和对话管理系统。
        -   `era-map/`: 一个**地图式沙盒模拟框架**，展示了引擎在驱动更复杂、带空间属性的模拟应用方面的能力。
        -   `custom-component/`: 一个强大的**动态组件系统**，允许用户在应用内使用 JSX/TSX 编写、即时编译并渲染自定义 Vue 组件。
        -   `dialog-test/`: 一个极简的对话测试应用，主要用于早期技术验证。
    -   `packages/`: 可复用的前端服务和 UI 组件库。
-   `Plugins/`: 后端插件项目，为引擎提供新的符文和功能。
    -   `YAESandBox.Plugin.LuaScript/`: 提供 Lua 脚本执行能力。
    -   `YAESandBox.Plugin.TextParser/`: 提供高级文本解析能力。
    -   `YAESandBox.Plugin.FileSystemConfigProvider/`: 提供从文件系统加载内置配置（如官方示例）的能力。

## 技术栈

*   **后端**: .NET 9, C# 13 Preview, ASP.NET Core
*   **脚本引擎**: NLua (Lua), Jint (JavaScript)
*   **前端**: Vue 3, TypeScript, Vite, Pinia, naive-ui, Monaco Editor
*   **桌面端**: Tauri
*   **API 与 Schema**: OpenAPI (Swagger), .NET 9 `JsonSchemaExporter`, openapi-typescript-codegen

## 快速上手

本项目通过官方启动器分发，采用点击即用的便携式设计，**无需用户手动编译源代码或安装 .NET/Node.js 等开发环境**。

启动器本身是一个独立的组件管理器，负责获取、更新和启动 YAESandBox 的所有部分（后端服务、前端应用及插件）。

> **平台支持说明**:
> 尽管 Tauri 是一个跨平台框架，但由于能力所限，目前我们仅提供预编译的 **Windows** 启动器。

请按照以下步骤操作：

1.  **获取启动器 (Get the Launcher)**
    *   前往本项目的 [**Releases 页面**](https://github.com/Creeper-of-Fire/YAESandBox/releases)。
    *   下载适用于 **Windows** 的最新版本的启动器可执行文件（例如 `yaesandbox-launcher.exe`）。

2.  **创建应用目录 (Create an Application Directory)**
    *   在您希望安装的位置，创建一个**新的空文件夹** (例如 `D:\YAESandBox`)。
    *   将下载的启动器可执行文件 **移动到这个新创建的文件夹中**。

    > **重要提示**: 这一步至关重要。启动器会在其**所在的目录**下创建所有必要的子文件夹（如 `backend`, `frontend`, `plugins` 等）并存放配置文件。将其置于一个独立的空文件夹内可以保持您的文件系统整洁，并确保应用以“便携模式”正确运行。

3.  **首次运行与组件安装 (First Run & Component Installation)**
    *   直接运行文件夹内的启动器程序。
    *   首次运行时，启动器会自动连接默认的更新源，并下载所有必需的核心组件和插件。您可以在界面中看到各个组件的下载和安装状态。

4.  **启动应用 (Launch the Application)**
    *   待所有组件都安装完毕并显示为“最新”状态后，点击界面左下角的 **启动应用** 按钮。
    *   这将会启动本地的后端服务，并打开 YAESandBox 的主应用界面。现在，您可以开始使用**工作台 (Workbench)**、**Era-Lite** 等所有已安装的功能了。