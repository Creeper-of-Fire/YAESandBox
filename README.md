# YAESandBox - AI 原生可扩展工作流引擎

YAESandBox 是一个为构建复杂、动态、AI 驱动的交互式应用而设计的现代化后端与前端工具链。其核心是一个高度可扩展、支持智能并行调度的工作流引擎，旨在将复杂的逻辑流程拆解为可组合、可重用、可配置的模块化单元。

**项目状态: 核心引擎与编辑器工作台已完成**

本项目已经超越了早期原型阶段。核心的并行工作流引擎、插件化架构和动态表单驱动的可视化编辑器（工作台）已经实现并稳定（大概？）运行。我们通过一个对话测试应用 (`dialog-test`) 验证了整个技术栈的端到端连通性。

## 核心理念：组合优于继承，配置优于编码

YAESandBox 的设计哲学围绕着三个核心原则：

1.  **万物皆插件 (Plugin-First):** 从核心功能到第三方扩展，整个系统都构建在统一的插件模型之上。每个插件都可以独立提供后端逻辑（符文）、前端 UI 组件和静态资源。
2.  **双层数据流模型 (Dual Data-Flow Model):** 我们认识到不同粒度的逻辑需要不同的编排方式。因此，我们创造性地结合了两种数据流模型：
    *   **宏观（工作流-枢机）- 节点连接:** 在高层级，使用类似流程图的显式节点连接来定义枢机（Tuum）之间的执行顺序和数据依赖，清晰直观。引擎甚至支持**自动连接**，极大简化了配置。
    *   **微观（枢机-符文）- 变量总线:** 在枢机内部，采用“生产-消费”的变量总线模型。符文（Rune）向内部总线生产变量，或从总线消费变量，实现了高度解耦和灵活性，提供了类似编写高级脚本的体验。
3.  **代码即画布 (Code as Canvas):** 我们相信最好的创作工具应该提供代码般的灵活性和图形界面的直观性。前端工作台通过**实时静态分析**、**上下文感知自动完成**和**动态表单**，为用户提供了一个无需拖拽连线，却能洞察全局数据流的智能编辑环境。

## 核心概念

整个引擎由三个核心抽象构成，形成了`工作流 (Workflow) -> 枢机 (Tuum) -> 符文 (Rune)`的层级结构。

*   **符文 (Rune):** 最小的、原子的执行单元，代表一个具体的操作（如调用一次 AI、处理一段文本、执行一段 Lua 脚本）。符文是功能的基本积木。
*   **枢机 (Tuum):** 一个由多个符文按顺序组成的、可重用的逻辑块，类似于一个“函数”或“子程序”。它拥有自己的内部变量作用域，并通过**输入/输出映射**精确控制与外部的数据交互。
*   **工作流 (Workflow):** 由多个枢机通过节点连接组成的最高层级执行图（DAG）。它定义了整个业务流程的宏观逻辑。
*   **枢机符文 (TuumRune):** 这是一个特殊的符文，其内部封装了另一个完整的枢机。这使得复杂的逻辑可以被层层嵌套和抽象，实现了架构上的**分形设计 (Fractal Design)**，极大提升了工作流的组织能力和复用性。

## 关键特性一览

*   **🔌 全栈插件化架构:**
    *   后端通过 `IProgramModuleRuneProvider` 接口自动发现和加载插件定义的符文。
    *   前端通过约定的资源目录 (`wwwroot`) 动态加载插件提供的 Vue 组件、Web Components 和 CSS 样式。

*   **🧠 智能并行工作流引擎:**
    *   自动分析枢机间的**数据依赖关系**，构建执行图（DAG）。
    *   **并行执行**无依赖关系的枢机，显著提升了涉及多个 I/O 密集型操作（如多次 AI 调用）的执行效率。

*   **🔬 实时静态分析与校验:**
    *   强大的类型系统 (`VarSpec`) 和分析服务 (`TuumAnalysisService`, `WorkflowValidationService`)。
    *   在保存和执行前，就能对数据流的完整性、变量类型的兼容性、符文的放置规则进行全面检查，为动态的工作流配置提供了“编译时”的安全保障。

*   **🤖 深度集成 AI 服务:**
    *   独立的 `AIService` 模块，支持通过插件扩展接入不同的 AI 模型（已内置火山豆包、DeepSeek 等）。
    *   提供统一的配置管理和动态 Schema 生成，可在前端为任何 AI 模型**自动生成配置表单**。

*   **✨ 先进的可视化工作台 (`workbench`):**
    *   基于 Vue 和 Pinia 构建的单页面应用，提供对工作流、枢机、符文的完整 CRUD 管理。
    *   **动态 Schema 驱动 UI:** 可根据后端 C# 类的 Attribute **自动渲染**出复杂的配置表单，包括对 Monaco Editor (`RenderWithMonacoEditor`) 和自定义 Vue/Web Components (`RenderWithVueComponent`) 的支持。
    *   **智能感知编辑:** 提供变量的上下文自动完成和实时错误提示，极大提升了配置效率和准确性。

*   **🚀 可扩展的符文生态:**
    *   已实现强大的 Lua 脚本插件 (`YAESandBox.Plugin.Rune.LuaScript`)，支持通过 Bridge 与 .NET 环境交互，并为 Monaco Editor 提供了完整的 LSP 支持。
    *   提供了文本解析插件 (`YAESandBox.Plugin.Rune.TextParser`)，展示了如何通过自定义 Vue 组件扩展编辑器功能。

## 项目结构

本项目采用 Monorepo 结构，清晰地分离了不同层次的关注点：

-   `backend/`: 包含所有 .NET 后端项目。
    -   `YAESandBox.AppWeb/`: 主机应用，负责启动服务器、加载所有模块和插件。
    -   `YAESandBox.Workflow/`: **核心工作流引擎**，包含引擎、API、分析服务和内置符文。
    -   `YAESandBox.Workflow.AIService/`: 可插拔的 AI 服务管理模块。
    -   `YAESandBox.Depend.*/`: 底层依赖库，提供 `Result` 模式、存储、Schema 生成等通用能力。
    -   `YAESandBox.Authentication/`: 用户认证模块。
    -   `YAESandBox.Workflow.Test/`: 一个用于测试和演示工作流执行的最小化后端应用。
-   `frontend/`: 包含所有前端项目。
    -   `apps/shell/`: 主应用外壳，负责插件加载、路由和整体布局。
    -   `plugins/workbench/`: **核心的工作流可视化编辑器**。
    -   `plugins/dialog-test/`: 一个基于工作流构建的**对话测试应用**，作为引擎的端到端示例。
    -   `packages/`: 可复用的前端 UI 库和服务。
-   `Plugins/`: 存放独立的、可插拔的后端插件项目，每个插件都可以为系统带来新的符文和功能。

## 技术栈

*   **后端**: .NET 9, C# 13 Preview, ASP.NET Core, NLua
*   **前端**: Vue 3, TypeScript, Vite, Pinia, naive-ui
*   **API 生成**: OpenAPI (Swagger), NJsonSchema, openapi-typescript-codegen

## 当前状态与快速上手

目前，项目的核心引擎和编辑器功能已趋于稳定。最直接的体验方式是：

1.  启动 `YAESandBox.AppWeb` 后端服务。
2.  运行 `frontend/apps/shell` 前端应用。
3.  在浏览器中访问**工作台 (workbench)**，你可以在这里创建、编辑和管理工作流、枢机和符文的配置。
4.  访问**对话测试 (dialog-test)** 页面，选择一个已配置好的工作流，体验一个由引擎驱动的简单交互式应用。